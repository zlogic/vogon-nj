<button class="my-fab" mat-fab="mat-fab" *ngIf="!isEditing()" (click)="addTransaction()"><mat-icon>add</mat-icon></button>
<transaction-editor *ngIf="isEditing()" [transaction]="editingTransaction" (done)="stopEditing()"></transaction-editor>

<div class="table-container">
  <form #filterForm="ngForm" autocomplete="off" novalidate="novalidate">
    <div style="display: flex; align-items: center; flex-wrap: wrap;">
      <div style="flex: 1 1 auto;">
        <mat-form-field class="tags-input-fullwidth">
          <input matInput type="text" i18n-placeholder placeholder="Description filter" name="filterDescription" [(ngModel)]="transactionsService.filterDescription" />
        </mat-form-field>
      </div>
      <span>&nbsp;</span>
      <div style="flex: 1 1 auto; min-width: 200px;">
        <tags-input i18n-placeholder placeholder="Tags filter" name="filterTags" class="tags-input-fullwidth" [ngModel]="transactionsService.filterTags"></tags-input>
      </div>
      <span>&nbsp;</span>
      <div style="display: block;">
        <mat-form-field>
          <input matInput [matDatepicker]="picker" i18n-placeholder placeholder="Date filter" name="filterDate" [(ngModel)]="transactionsService.filterDate" />
          <mat-datepicker-toggle matSuffix type="button" [for]="picker"></mat-datepicker-toggle>
        </mat-form-field>
        <mat-datepicker #picker></mat-datepicker>
      </div>
    </div>
  </form>
  <table mat-table [dataSource]="transactionsService.transactions" matSort [matSortActive]="getSortColumn()" [matSortDirection]="getSortDirection()" matSortDisableClear (matSortChange)="sortData($event)" class="mat-elevation-z4" 
    infiniteScroll="infiniteScroll" (scrolled)="transactionsService.nextPage()" [infiniteScrollDisabled]="transactionsService.isLoadingNextPage() || transactionsService.isLastPage()" [immediateCheck]="true" [infiniteScrollContainer]="'mat-sidenav-content'" [fromRoot]="true">
    <ng-container matColumnDef="description">
      <th mat-header-cell *matHeaderCellDef mat-sort-header i18n>Description</th>
      <td mat-cell *matCellDef="let transaction">
        <div>{{transaction.description}}</div>
        <div style="margin-top: 4px; margin-bottom: 4px;">
          <mat-chip-list>
            <mat-chip *ngFor="let tag of transaction.tags" disabled="true">{{tag}}</mat-chip>
          </mat-chip-list>
        </div>
      </td>
    </ng-container>
    <ng-container matColumnDef="date">
      <th mat-header-cell *matHeaderCellDef mat-sort-header i18n>Date</th>
      <td mat-cell *matCellDef="let transaction">{{transaction.date | date}}</td>
    </ng-container>
    <ng-container matColumnDef="accounts">
      <th mat-header-cell *matHeaderCellDef i18n>Accounts</th>
      <td mat-cell *matCellDef="let transaction">
        <ng-template [ngIf]="transactionsService.isExpenseIncomeTransaction(transaction)">
            <div *ngFor="let account of transactionsService.getAccounts(transaction, transactionsService.allAccountsPredicate); last as last">{{account.name}}{{last ? '' : ', '}}</div>
        </ng-template>
        <ng-template [ngIf]="transactionsService.isTransferTransaction(transaction)">
          <div *ngFor="let account of transactionsService.getAccounts(transaction, transactionsService.fromAccountsPredicate); last as last; first as first">{{first && !last ? '(' : ''}}{{account.name}}{{last ? '' : ', '}}{{last && !first ? ')' : ''}}</div>
          <mat-icon>arrow_downward</mat-icon>
          <div *ngFor="let account of transactionsService.getAccounts(transaction, transactionsService.toAccountsPredicate); last as last; first as first">{{first && !last ? '(' : ''}}{{account.name}}{{last ? '' : ', '}}{{last && !first ? ')' : ''}}</div>
        </ng-template>
      </td>
    </ng-container>
    <ng-container matColumnDef="amount">
      <th mat-header-cell *matHeaderCellDef i18n>Amount</th>
      <td mat-cell *matCellDef="let transaction" [ngClass]="{'amount-not-valid': !transactionsService.isAmountOk(transaction)}">
        <div *ngFor="let currencyAmount of totalsByCurrency(transaction)" style="text-align: right;"><span *ngIf="transactionsService.isTransferTransaction(transaction)">&sum;</span>{{currencyAmount.amount | number:"1.2-2"}} {{currencyAmount.currency}}</div>
      </td>
    </ng-container>
    <ng-container matColumnDef="menu">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let transaction">
        <div style="text-align: right;">
          <button mat-icon-button="mat-icon-button" [matMenuTriggerFor]="transactionMenu" i18n-aria-label aria-label="Open menu"><mat-icon>more_vert</mat-icon></button>
          <mat-menu #transactionMenu="matMenu">
            <button mat-menu-item (click)="duplicateTransaction(transaction)"><mat-icon>content_copy</mat-icon><span i18n>Duplicate</span></button>
            <button mat-menu-item (click)="startEditing(transaction)"><mat-icon>edit</mat-icon><span i18n>Edit</span></button>
            <button mat-menu-item (click)="deleteTransaction(transaction)">
            <mat-icon>delete_forever</mat-icon><span i18n>Delete</span></button>
          </mat-menu>
        </div>
      </td>
    </ng-container>
    <ng-container matColumnDef="loading">
      <td mat-footer-cell *matFooterCellDef colspan="5">
        <div><span i18n>Loading...</span></div>
        <div>
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        </div>
      </td>
    </ng-container>
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    <tr mat-footer-row *matFooterRowDef="['loading']" [hidden]="!transactionsService.isLoadingNextPage()"></tr>
  </table>
</div>